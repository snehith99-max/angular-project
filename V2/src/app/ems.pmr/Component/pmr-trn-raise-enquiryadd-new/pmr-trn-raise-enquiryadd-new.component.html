<div class="card m-5">
    <div class="card-title p-5 pb-3 pt-3 rounded-top bg-primary d-flex justify-content-between align-items-center">
      <h1 class="fw-bolder text-white"><i class="fa fa-shopping-cart fs-2" aria-hidden="true"></i>&nbsp;&nbsp;Direct
        Purchase Enquiry</h1>
  
  
      <button style="color: black !important;" class="btn btn-icon btn-sm bg-secondary cursor-pointer " title="back"
        routerLink="/pmr/PmrTrnRaiseEnquiry"><i class="fa-solid fa-arrow-left-long fs-1 fw-bold"></i></button>
  
  
    </div>
    <!-- -------------- First Tab ------------- -->
    <div class="card mt-1 m-3 mb-0">
      <div 
        class="card-header d-flex align-items-center mb-3 cursor-pointer" style="background-color: #def0ff;">
        <div>
          <p class="card-title fw-bold fs-3" style="color: #2599ff;">
            <i class="fa-solid fa-clipboard fs-1"></i> &nbsp;&nbsp;Enquiry Details
          </p>
        </div>
        <div class="ms-auto pt-1 ">
          <button class="btn text-decoration-none " style="color: #2599ff;">
            <i class="fa-solid fa-caret-down fs-1" *ngIf="!sam"></i>
            <i class="fa-solid fa-caret-up fs-1" *ngIf="sam"></i>
          </button>
        </div>
      </div>
  
      <div >
        <form [formGroup]="PurchaseEnquiryForm">
          <div class="d-flex row m-3 flex-wrap">
            <div class="col-12 col-lg-8 col-md-12 col-sm-12">
              <div class="card p-4 pb-5 border mt-2">
                <div class="row g-7 ">
                    <div class="col-12 col-lg-6 ">
                        <span class="font-bold">Enquiry Ref No.</span>
                        <div class="col-lg-12 col-12 fv-row mt-4">
                            <input type="text" class="
                                 form-control form-control-lg form-control-solid custom-input
                                 mb-3 mb-lg-0  borderc-secondary bg-white custom-input" placeholder="New Reference No"
                                formControlName="enquiry_gid" class="form-control " style="height: 40px;" readonly />
                        </div>
                    </div>
                   
                    <div class="col-12 col-lg-6 ">
                        <span class="font-bold">Enquiry Date<span class="ms-1 text-red">*</span></span>
                        <div class="col-lg-12 col-12 fv-row mt-4">
                          <input type="date" pattern="^(?!\s*$).+" 
                          [ngStyle]="{ 'border-color': PurchaseEnquiryForm.get('enquiry_date')?.hasError('required')
                                             && PurchaseEnquiryForm.get('enquiry_date')?.touched ? 'red' : 'rgb(209, 209, 209)'}"
                            formControlName="enquiry_date" 
                            class="form-control form-control-lg form-control-solid date-picker mb-3 mb-lg-0 bg-white
                                       custom-input date-picker " 
                                       placeholder="DD-MM-YYYY" 
                                       style="height: 40px;" />
                          <!-- <div *ngIf="PurchaseEnquiryForm.get('enquiry_date').invalid && PurchaseEnquiryForm.get('enquiry_date').touched"
                            style="color: red;">
                            Enquiry Date is Required
                          </div> -->
                        </div>
                      </div>
                     
                        
                        
                 
                    <div class="col-12 col-lg-6 ">
                        <div class="mt-2">
                          <span class="font-bold" [ngClass]="{'error_input_field': branch_name.invalid && branch_name.touched}">Branch<span class="ms-1 text-red">*</span></span>
                          <div class="col-lg-12 col-12 fv-row mt-4">
                            <ng-select formControlName="branch_name" (change)="OnChangeBranch()" (clear)="onclearbranch()"
                             [class.is-invalid]="branch_name.invalid" 
                              [ngClass]="{'invalid-border': branch_name.invalid && branch_name.touched}" [items]="branch_list"
                              required class="custom fv-row mt-4" bindLabel="branch_name" bindValue="branch_gid"
                              placeholder="Select an option" [(ngModel)]="mdlBranchName">
                            </ng-select>
                            <!-- <div *ngIf="branch_name.invalid && branch_name.touched" class="invalid-feedback">
                              <div *ngIf="branch_name.errors?.['required']">
                                Branch Name is required.
                              </div>
                            </div> -->
                          </div>
                        </div>
      
      
                      </div>
                      <div class="col-12 col-lg-6">
  
                        <span class="font-bold ">Branch Address</span>
                        <div class="col-lg-12  fv-row mt-4">
                          <textarea type="text"
                            class="form-control form-control-lg form-control-solid mb-3 mb-lg-0 borderc-secondary bg-white resize_none"
                            placeholder="Branch Address" formControlName="vendor_address" [(ngModel)]="mdlDispatchadd"
                            rows="2"></textarea>
                        </div>
      
                      </div>
                     
                        
                            <div class="col-12 col-lg-6 ">
                       
                            <span class="font-bold">Enquiry Cover Note</span>
                            <div class="col-lg-12 col-12 fv-row mt-4">
                                <textarea type="text" class="
                            form-control form-control-lg form-control-solid custom-input
                            mb-3 mb-lg-0  borderc-secondary bg-white custom-input" formControlName="enquiry_remarks"
                                    class="form-control"></textarea>
                            </div>
                       
            
                    </div>
                    <div class="col-12 col-lg-6 ">
                        <span class="font-bold">Vendor Requirement</span>
                        <div class="col-lg-12 col-12 fv-row mt-4">
                            <textarea type="text" class="
                        form-control form-control-lg form-control-solid custom-input
                        mb-3 mb-lg-0  borderc-secondary bg-white custom-input" formControlName="vendor_requirement"
                                class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 ">
                        <span class="font-bold"[ngClass]="{'error_input_field': currency_list.invalid && currency_list.touched}">Currency<span class="ms-1 text-red">*</span></span>
                        <div class="col-lg-12 col-12 fv-row mt-4">
                          <div class="row">
          
                            <div class="col-lg-9 col-9 fv-row ">
                              <ng-select formControlName="currency_code" [items]="currency_list" (change)="OnChangeCurrency()"
                                (clear)="onclearcurrency()" required class="custom " bindLabel="currency_code"
                                bindValue="currencyexchange_gid" placeholder="Currency" [(ngModel)]="mdlCurrencyName">
                                <option *ngFor="let currency of currency_list" [value]="currency.currencyexchange_gid"
                                  style="height: 40px;">
                                  {{currency.currency_code}}</option>
                              </ng-select>
                            </div>
                            <div class="col-lg-3 col-3 fv-row ">
                              <input type="number" [(ngModel)]="exchange" readonly style="text-align:right;"
                                class="form-control form-control-lg form-control-solid custom-input mb-3 mb-lg-0 borderc-secondary bg-white custom-input "
                                placeholder="0.00" formControlName="exchange_rate" style="height: 40px;" />
                            </div>
                          </div>
                        </div>
                      </div>
                    
                    <div class="col-12 col-lg-6 ">
                        <span class="font-bold">Expected Closure Date<span class="ms-1 text-red">*</span></span>
                        <div class="col-lg-12 col-12 fv-row mt-4">
                          <input type="date" pattern="^(?!\s*$).+" [ngStyle]="{ 'border-color': PurchaseEnquiryForm.get('closure_date')?.hasError('required')
                                             && PurchaseEnquiryForm.get('closure_date')?.touched ? 'red' : 'rgb(209, 209, 209)'}"
                            formControlName="closure_date" class="form-control form-control-lg form-control-solid date-picker mb-3 mb-lg-0 bg-white
                                       custom-input date-picker " placeholder="DD-MM-YYYY" style="height: 40px;" />
                          <div *ngIf="PurchaseEnquiryForm.get('closure_date').invalid && PurchaseEnquiryForm.get('closure_date').touched"
                            style="color: red;">
                            Expected Closure Date is Required
                          </div>
                        </div>
                      </div>
                 
                
                </div>
              </div>
  
            </div>
            <div class="col-12 col-lg-4 col-md-12 col-sm-12">
              <div class="card p-4 border mt-2">
                <div class="row g-7 ">
                  <div class="col-12">
                    <!-- <span class="font-bold">Vendor Enquiry Ref. No<span class="ms-1 text-red">*</span></span> -->
                    <span class="font-bold"[ngClass]="{'error_input_field': enquiry_referencenumber.invalid && enquiry_referencenumber.touched}">Vendor Enquiry Ref. No<span class="ms-1 text-red">*</span></span>
                    <div class="col-lg-12 col-12 fv-row mt-4">
                        <input type="text" class="form-control form-control-lg form-control-solid custom-input mb-3 mb-lg-0  borderc-secondary bg-white custom-input" style="height: 40px;"
                        [ngClass]="{'invalid-border': enquiry_referencenumber.invalid && enquiry_referencenumber.touched}" 
            class="custom col-lg-11 col-12 col-md-11 col-sm-11 fv-row mt-2"
                        required  placeholder="Vendor Enquiry Ref. No" formControlName="enquiry_referencenumber"
                            class="form-control" />
                    </div>
                </div>
                  <div class="col-12">
                    <span class="font-bold"[ngClass]="{'error_input_field': vendor_companyname.invalid && vendor_companyname.touched}">Vendor<span class="ms-1 text-red">*</span></span>
                    <div class="col-lg-12 col-12 fv-row mt-4">
                        
                        <ng-select formControlName="vendor_companyname" (change)="OnChangeVendor()"
                      (clear)="onclearvendor()"
                      [class.is-invalid]="vendor_companyname.invalid && (vendor_companyname.dirty || vendor_companyname.touched)"
                      [ngClass]="{'invalid-border': vendor_companyname.invalid && vendor_companyname.touched}"
                      [items]="vendor_list" required class="custom " bindLabel="vendor_companyname"
                      bindValue="vendor_gid" placeholder="Select an option" [(ngModel)]="mdlVendorName">
                      <option *ngFor="let vendor of vendor_list" [value]="vendor.vendor_gid">
                        {{vendor.vendor_companyname}}</option>
                    </ng-select>
                    <!-- <div *ngIf="vendor_companyname.invalid && (vendor_companyname.dirty || vendor_companyname.touched)" class="invalid-feedback">
                      <div *ngIf="vendor_companyname.errors?.['required']">
                        Vendor Name is required.
                      </div>
                      <ng-template #vendorError>
                        <div class="error-message">Please select a vendor.</div>
                     </ng-template>
                    </div> -->
                    </div>
                  </div>
                  <div class="col-12 ">
                    <span class="font-bold">Ship To</span>
                    <div class="col-lg-12 col-12 fv-row mt-4">
                      <textarea type="text"
                        class="form-control form-control-lg form-control-solid mb-2 mb-lg-0  borderc-secondary bg-white  resize_none"
                        formControlName="shipping_address" placeholder="Ship To"
                        [(ngModel)]="mdlcontactperson" rows="3"></textarea>
                    </div>
                  </div>
                  <div class="col-12 ">Enquiry Rating
                    <div class="col-lg-12 col-12 fv-row mt-4">
                            <ng-select formControlName="customer_rating" required
                                class="custom col-lg-12 col-12 col-md-12 col-sm-12 fv-row mt-2"
                                placeholder="Select an option">
                                <ng-option value="Cold">Cold</ng-option>
                                <ng-option value="Warm">Warm</ng-option>
                                <ng-option value="Hot">Hot</ng-option>
                            </ng-select>
                        </div>
                    </div>
                </div>
              </div>
  
            </div>
          </div>
  
          
        </form>
      </div>
    </div>
    <!-- --------------Second Tab ------------- -->
    <div class="card mt-1 m-3 mb-0">
      <div class="card-header d-flex align-items-center mb-3 cursor-pointer rounded-top" id="toggleBtn"
     style="background-color: #def0ff;">
        <div>
          <p class="card-title fw-bold fs-3" style="color: #2599ff;">
            <i class="fa-solid fa-box-archive fs-1"></i> &nbsp; Product Details
          </p>
        </div>
        <div class="ms-auto pt-1 ">
          <button class="btn text-decoration-none " style="color: #2599ff;">
            <i class="fa-solid fa-caret-down fs-1" *ngIf="!arrowfst"></i>
            <i class="fa-solid fa-caret-up fs-1" *ngIf="arrowfst"></i>
          </button>
        </div>
      </div>
  
      <div >
  
        <div class="d-flex row m-1 flex-wrap">
  
          <div class="col-lg-12">
  
            <div class="row">
              <div class="col-lg-6">
                <form [formGroup]="productform">
                  <div class="row  flex-wrap mb-2">
                    <div class="col-1 d-flex justify-content-center align-items-center rounded "
                      style="background-color: #deefff;">
                      <span><i class="fa-solid fa-filter fs-1" style="color: #2599ff;"></i></span>
                    </div>
                    <div class="col-5">
                      <div class="col-12 fv-row ">
                        <ng-select formControlName="producttype_name"
                          [class.is-invalid]="producttype_name.invalid && (producttype_name.dirty || producttype_name.touched)"
                          [items]="producttype_list" required class="custom col-12" bindLabel="producttype_name"
                          bindValue="producttype_gid" placeholder="Select Product Category" [(ngModel)]="mdlproducttype"
                          (ngModelChange)="productSearch()">
                        </ng-select>
                      </div>
                    </div>
                    <div class="col-5">
                      <div class="col-12 fv-row ">
                        <input type="text"
                          class="form-control form-control-lg form-control-solid custom-input mb-3 mb-lg-0 borderc-secondary bg-white custom-input"
                          placeholder="Search Product Name" formControlName="product_name"
                          style="height: 40px;border-radius: 9px;" class="form-control" (input)="productSearch()" />
                      </div>
                    </div>
  
  
                  </div>
                </form>
              </div>
              <div class="col-lg-6">
                <div class="text-end">
                  <button class="btn-success btn-lg fs-2" (click)="productSubmit()"
                    id="toggleBtn"><i class="fa-solid fa-plus"></i> &nbsp;Add Product</button>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <div style="max-height: 250px; overflow-y: auto;" class="border rounded">
                <table class="table table-striped table-row-bordered border-bottom gs-7 align-middle"
                  *ngIf="POProductList1 && POProductList1.length !== 0">
                  <thead>
                    <tr class="fw-bold fs-7 text-nowrap bg-lightblue text-blue align-middle">
                      <th>S.No</th>
                      <th>Product Code</th>
                      <th style="width: 15%;">Product</th>
                      <!-- <th style="width: 15%;">Product Description </th> -->
                      <th style="width: 10%;">Quantity Requested</th>
                      <th>Unit</th>
                      <th>Potential Value</th>
                      <th>Need By Date</th>
                      <!-- <th>Unit Price</th>
                      <th>Discount</th>
                      <th class="text-right" style="display: none;">Tax Details(Per Qty)</th>
                      <th  style="display: none;">Tax Amount </th>
                      <th>Total Amount</th> -->
                      <th class="text-center bg-lightblue ">Action</th> 
  
  
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let data of POProductList1; let i=index;" class="align-middle">
                      <td>{{i+1}}</td>
                      <td>{{data.product_code}}</td>
                      <td>{{data.product_name}}<br>
                        <div>
                          <textarea type="text"
                            class="form-control form-control-lg form-control-solid borderc-secondary bg-white resize_none"
                            placeholder="Product Description" [(ngModel)]="data.display_field" rows="1"></textarea>
                        </div>
                      </td>
  
                    
                      <td>
                        <div style="width: 10%;"> <input type="number"
                            class="form-control form-control-lg form-control-solid custom-input mb-1 mb-lg-2 borderc-secondary bg-white custom-input"
                            style="height:20px; width: 85px;" [(ngModel)]="data.qty_requested" ></div>
  
                      </td>
                      <td>{{data.productuom_name}}</td>
                      <td>
                        <input type="number"
                          class="form-control form-control-lg form-control-solid custom-input mb-1 mb-lg-2 borderc-secondary bg-white custom-input"
                          style="height:20px; width: 125px;" [(ngModel)]="data.potential_value" value="data.potential_value"
                          (input)="prodtotalcal(i)">
                      </td>
  
                      <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                          <input
                            type="date"
                            pattern="^(?!\s*$).+"
                            style="height: 20px; width: 140px;"                         
                          
                            [(ngModel)]="data.product_requireddate"
                            class="form-control form-control-lg form-control-solid date-picker mb-3 mb-lg-0 bg-white custom-input date-picker"
                            placeholder="DD-MM-YYYY"
                          />
                          <textarea  style="height: 20px; width: 140px;"
                            class="form-control form-control-lg form-control-solid borderc-secondary bg-white resize_none"
                            placeholder="Remarks"
                            [(ngModel)]="data.product_requireddateremarks"
                            rows="1"                          
                          ></textarea>
                        </div>
                      </td>
                      
  
  
                     
                      <td style="width: 5%;">
                        <button title="Add" type="button" class="btn btn-icon btn-sm bg-success me-2"
                                (click)="productAdd(data.product_gid)">
                                <span Class="fa-solid fa-plus text-white  fs-6"></span></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
  
  
            </div>
          </div>
  
  
        </div>
  
      </div>
   
  
  
  
  
  
  
    </div>
       <!-- --------------Third Tab ------------- -->
  
       <div class="card mt-1 m-3 mb-0">
        <div class="card-header d-flex align-items-center mb-3 cursor-pointer rounded-top"
         style="background-color: #def0ff;">
          <div>
            <p class="card-title fw-bold fs-3" style="color: #2599ff;">
              <i class="fa-solid fa-clipboard-list fs-1"></i> &nbsp; Product Summary
            </p>
          </div>
          <div class="ms-auto pt-1 ">
            <button class="btn text-decoration-none " style="color: #2599ff;">
              <i class="fa-solid fa-caret-down fs-1" *ngIf="!arrowOne"></i>
              <i class="fa-solid fa-caret-up fs-1" *ngIf="arrowOne"></i>
            </button>
          </div>
        </div>
        <div >
          <div >
            <div class="table-responsive ">
              <div style="max-height: 250px; overflow-y: auto;" class="border rounded m-2">
                <table id="productsummary_list" class="table table-striped table-row-bordered gy-4 gs-2 ">
                  <thead class="table_head mb-4">
                    <tr class="text-white fw-bold fs-5 text-nowrap  bg-lightblue card-height55 text-blue">
                      <th style="width:3%">S.No</th>
                      <th style="width:10%">Product Code</th>
                      <th style="width: 25%;">Product</th>
                      <th style="text-align: center; width:7%">Quantity Requested</th>
                     <th class="text-end">Potential Value</th>
                     <th >Need By Date</th>
                     <th >Remarks</th>
                      <th class="text-center">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let data of productsummary_list; let i=index;">
                      <td>{{i+1}}</td>
                      <td>{{data.product_code}}</td>
                      <td style="width: 20%;">{{data.product_name}}<br>{{data.display_field}}</td>
                      <td style="text-align: center; width:7%">
                        <span *ngIf="data.qty_requested % 1 === 0; else decimalQty">{{data.qty_requested}}</span>
                        <ng-template #decimalQty>{{data.qty.toFixed(2)}}</ng-template>
                        &nbsp;{{data.productuom_name}}
                      </td>
                      <td style="width: 20%;" class="text-end" >{{data.potential_value}}</td>
                      <td >{{data.product_requireddate}} </td>
                      <td> {{data.product_requireddateremarks}}</td>
                      <td class="text-center">
                        <button title="Delete" type="button" (click)="openModaldelete(data.tmpsalesenquiry_gid)"
                          data-bs-toggle="modal" data-bs-target="#myModaldeleteQA"
                          class="btn btn-icon btn-sm bg-danger me-1"><span
                            class="fa-solid fa-trash text-white  fs-6"></span></button>
                      </td>
  
                    </tr>
                  </tbody>
                </table>
              </div>
  
              <div class="text-center my-4">
                <button (click)="onSubmit()" type="submit" class="btn-success btn-sm text-white me-2">
                  <i class="fas fa-check fs-5"></i>
                  <span class="ms-3">Submit</span> </button>
        
              </div>
  
            </div>
          
          </div>
  
          <div class="modal" id="myModaldeleteQA" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content del_modal-content">
                <div class="text-center my-4">
                  <h2><b>Are you sure?</b></h2>
                  <p style="display: block;">Do You Want To Delete the Record ?</p>
                  <div class="text-center my-4">
                    <button class="btn-danger btn-sm text-white me-4" data-bs-dismiss="modal" (click)="ondelete()">
                      <i class="bi bi-trash-fill text-white fs-5 me-2"></i>Delete
                    </button>
                    <button class="btn-primary btn-sm text-white me-2" data-bs-dismiss="modal">
                      <i class="fas fa-close text-white me-2"></i>Close
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal fade" id="myModalUpdateimage9" tabindex="-1" data-bs-backdrop='static'
            aria-labelledby="editamlcategoryLabel" aria-hidden="true" data-bs-keyboard="false">
            <div id="kt_chat_contacts_body1">
              <div class="modal-dialog modal-md modal-dialog-centered modal-xl" style="max-width: 1000px;">
                <div class="modal-content  d-flex justify-content-center">
                  <div class="card-header pb-3 pt-6 rounded-top bg-primary">
                    <div>
                      <h3 class="fw-bolder text-white">
                        &nbsp;&nbsp;&nbsp;Tax Details </h3>
                    </div>
                  </div>
                  <div class="modal-body">
                    <div class="table-responsive">
                      <div class="mx-3 p-3 pt-0 pb-0 bg-white rounded">
                        <div><span style="font-size: 10px;font-weight: bold;">Product : <span id="mdlTaxSegment"
                              class="fw-bold" style="color: blue;">{{prod_name}}</span></span></div>
                        <div><span style="font-size: 10px;font-weight: bold;">Tax Segment : <span id="mdlTaxSegment"
                              class="fw-bold" style="color: blue;">{{mdlTaxSegment}}</span></span></div>
                        <div class="col-lg-11 col-12 col-md-11 col-sm-11 fv-row mt-2"
                          style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; height: auto; overflow-x: auto;width:auto">
  
                          <div class="tax-container">
                            <table id="GetTaxSegmentList" class="table table-striped table-row-bordered gy-5 gs-7">
                              <thead>
                                <tr class="fw-bold fs-7 text-nowrap bg-lightblue text-blue align-middle">
                                  <th>S.No</th>
                                  <th>Tax Segment</th>
                                  <th>Tax Percentage</th>
                                  <th class="text-end">Tax Amount</th>
                                </tr>
                              </thead>
                              <tbody>
                                <ng-container *ngFor="let taxSegment of GetTaxSegmentList; let i = index">
                                  <tr>
                                    <td>{{ i + 1 }}</td>
                                    <td>{{ taxSegment.tax_name }}</td>
                                    <td>{{ taxSegment.tax_percentage }}%</td>
                                    <td class="text-end">{{ (taxSegment.mrp_price * taxSegment.tax_percentage /
                                      100).toFixed(2) }}</td>
                                  </tr>
                                </ng-container>
                                <tr>
  
                                  <td></td>
                                  <td colspan="2" class="text-end"><span class="fw-bold">Total Tax(per Qty):&nbsp;</span>
                                  </td>
                                  <td class="text-end">{{ taxseg_tax | number: '1.2-2' }}</td>
  
  
                                </tr>
                              </tbody>
                            </table>
  
  
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="text-center my-4">
                      <button class="btn-primary btn-sm text-white me-2" data-bs-dismiss="modal"
                        style="background-color: red;">
                        <i class="fas fa-arrow-left text-white"></i> &nbsp;Back
                      </button>&nbsp;
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

     